<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quittances ‚Äî Locataires & PDF</title>

  <!-- PDF generator (HTML -> PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b31;
      --muted:#9fb0cc;
      --text:#eaf0ff;
      --border:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --accent2:#7ee7d6;
      --danger:#ff6e6e;
      --ok:#7ee7a7;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, rgba(110,168,255,.25), transparent 55%),
                  radial-gradient(1200px 800px at 80% 20%, rgba(126,231,214,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:28px;
    }
    a{ color:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; }
    header{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:16px; margin-bottom:18px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    .title h1{
      margin:0; font-size:28px; letter-spacing:.2px;
    }
    .title p{
      margin:0; color:var(--muted); font-size:14px;
    }
    .pillbar{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.15s;
    }
    .pill[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(110,168,255,.22), rgba(126,231,214,.14));
      border-color: rgba(110,168,255,.45);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .card .head h2{
      margin:0; font-size:16px; letter-spacing:.2px;
    }
    .card .head .hint{
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    .card .body{ padding:16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 680px){
      .row{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 86px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color:rgba(159,176,204,.7); }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(110,168,255,.28), rgba(126,231,214,.18));
      border-color: rgba(110,168,255,.45);
    }
    .btn.danger{
      background: rgba(255,110,110,.10);
      border-color: rgba(255,110,110,.35);
    }
    .btn:active{ transform: translateY(1px); }
    .note{
      color: var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.35;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .item .meta .name{
      font-weight:650;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }
    .item .meta .sub{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .item .right{
      display:flex;
      gap:8px;
      flex-shrink:0;
    }

    .split{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .toast{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    /* Hidden PDF template (will be converted to PDF) */
    .pdf-root{
      width: 210mm;
      min-height: 297mm;
      padding: 18mm 16mm;
      background: #ffffff;
      color: #0b1220;
      font-family: var(--sans);
    }
    .pdf-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14mm;
      margin-bottom: 10mm;
    }
    .pdf-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#334155;
      padding:6px 10px;
      border:1px solid #e2e8f0;
      border-radius:999px;
    }
    .pdf-title{
      margin: 8px 0 0 0;
      font-size: 26px;
      letter-spacing:.2px;
      color:#0b1220;
    }
    .pdf-period{
      margin: 4px 0 0 0;
      font-size: 14px;
      color:#334155;
    }
    .pdf-boxes{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8mm;
      margin-bottom: 8mm;
    }
    .pdf-box{
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 10mm 10mm;
      background: #fbfdff;
    }
    .pdf-box h3{
      margin:0 0 6px 0;
      font-size: 12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#475569;
    }
    .pdf-line{
      margin: 3px 0;
      font-size: 12.5px;
      color:#0b1220;
      white-space:pre-line;
    }
    .pdf-prop{
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      padding: 8mm 10mm;
      margin-bottom: 8mm;
      background:#ffffff;
    }
    .pdf-prop h3{
      margin:0 0 6px 0;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#475569;
    }
    .pdf-table{
      width:100%;
      border-collapse: collapse;
      margin-top: 2mm;
      font-size: 12.5px;
    }
    .pdf-table th, .pdf-table td{
      border-bottom: 1px solid #e2e8f0;
      padding: 10px 6px;
      text-align:left;
    }
    .pdf-table th{
      font-size: 12px;
      color:#475569;
      font-weight:650;
    }
    .pdf-table td:last-child, .pdf-table th:last-child{
      text-align:right;
    }
    .pdf-total{
      margin-top: 6mm;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 8mm 10mm;
      background: linear-gradient(135deg, rgba(110,168,255,.12), rgba(126,231,214,.10));
    }
    .pdf-total .big{
      font-size: 18px;
      font-weight: 750;
      margin: 0;
    }
    .pdf-total .small{
      margin: 6px 0 0 0;
      color:#334155;
      font-size: 12.5px;
      line-height:1.45;
    }
    .pdf-footer{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10mm;
      margin-top: 10mm;
      padding-top: 8mm;
      border-top: 1px solid #e2e8f0;
    }
    .pdf-footer .left{
      color:#334155;
      font-size: 11.5px;
      line-height:1.45;
    }
    .pdf-sign{
      width: 70mm;
      text-align:right;
      font-size: 12.5px;
      color:#0b1220;
    }
    .pdf-sign .sigbox{
      margin-top: 18mm;
      border-top: 1px solid #0b1220;
      padding-top: 6px;
      color:#334155;
      font-size: 11.5px;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Quittances</h1>
      <p>Enregistre tes locataires (loyer HC + charges) et g√©n√®re des quittances PDF au design √©pur√©.</p>
    </div>
    <div class="pillbar" role="tablist" aria-label="Navigation">
      <div class="pill" role="tab" tabindex="0" aria-selected="true" data-tab="bailleur">Bailleur</div>
      <div class="pill" role="tab" tabindex="0" aria-selected="false" data-tab="locataires">Locataires</div>
      <div class="pill" role="tab" tabindex="0" aria-selected="false" data-tab="quittances">Quittances PDF</div>
    </div>
  </header>

  <div class="grid">
    <section class="card" id="leftCard">
      <div class="head">
        <h2 id="leftTitle">Informations bailleur</h2>
        <div class="hint" id="leftHint">stockage local ‚Ä¢ aucun serveur</div>
      </div>
      <div class="body" id="leftBody"></div>
    </section>

    <aside class="card">
      <div class="head">
        <h2>Outils</h2>
        <div class="hint">export/import</div>
      </div>
      <div class="body">
        <div class="split">
          <div>
            <button class="btn" id="btnExport">Exporter les donn√©es (.json)</button>
            <input type="file" id="fileImport" accept="application/json" class="hidden" />
            <button class="btn" id="btnImport">Importer des donn√©es (.json)</button>
            <div class="note">
              <b>Astuce :</b> sur GitHub Pages, l‚Äôapp n‚Äôa pas de base de donn√©es.
              <br/>L‚Äôexport/import te permet de sauvegarder ou transf√©rer tes infos.
            </div>
          </div>

          <div>
            <button class="btn danger" id="btnReset">R√©initialiser (effacer tout)</button>
            <div class="note">
              Les donn√©es sont stock√©es dans ton navigateur (LocalStorage).
              Si tu changes d‚Äôordinateur/navigateur, tu ne les verras pas sans import.
            </div>
          </div>

          <div class="toast" id="toast"></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Hidden PDF template -->
  <div id="pdfTemplate" class="hidden">
    <div class="pdf-root">
      <div class="pdf-top">
        <div>
          <div class="pdf-badge">QUITTANCE ‚Ä¢ LOYER</div>
          <h2 class="pdf-title" id="pdfTitle">Quittance de loyer</h2>
          <p class="pdf-period" id="pdfPeriod">P√©riode : ‚Äî</p>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:#334155">R√©f√©rence</div>
          <div style="font-family:var(--mono);font-size:12px;color:#0b1220" id="pdfRef">‚Äî</div>
        </div>
      </div>

      <div class="pdf-boxes">
        <div class="pdf-box">
          <h3>Bailleur</h3>
          <div class="pdf-line" id="pdfLandlordLines">‚Äî</div>
        </div>
        <div class="pdf-box">
          <h3>Locataire</h3>
          <div class="pdf-line" id="pdfTenantLines">‚Äî</div>
        </div>
      </div>

      <div class="pdf-prop">
        <h3>Logement</h3>
        <div class="pdf-line" id="pdfProperty">‚Äî</div>
      </div>

      <table class="pdf-table">
        <thead>
          <tr>
            <th>D√©tail</th>
            <th>Montant</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Loyer (hors charges)</td>
            <td id="pdfRent">‚Äî</td>
          </tr>
          <tr>
            <td>Provision pour charges</td>
            <td id="pdfCharges">‚Äî</td>
          </tr>
          <tr>
            <td style="font-weight:700">Total pay√©</td>
            <td style="font-weight:800" id="pdfTotal">‚Äî</td>
          </tr>
        </tbody>
      </table>

      <div class="pdf-total">
        <p class="big" id="pdfTotalLine">Total : ‚Äî</p>
        <p class="small" id="pdfStatement">
          Le bailleur reconna√Æt avoir re√ßu la somme indiqu√©e ci-dessus au titre du paiement
          du loyer et des charges pour la p√©riode mentionn√©e. Cette quittance atteste du paiement int√©gral des sommes dues.
        </p>
      </div>

      <div class="pdf-footer">
        <div class="left" id="pdfFooterLeft">
          Fait √† ‚Äî, le ‚Äî<br/>
          Paiement : ‚Äî<br/>
          <span style="color:#64748b">Document g√©n√©r√© automatiquement.</span>
        </div>
        <div class="pdf-sign">
          <div style="font-weight:700" id="pdfSignName">‚Äî</div>
          <div class="sigbox">Signature du bailleur</div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // -------------------------
  // State & Storage
  // -------------------------
  const STORAGE_KEY = "quittances_state_v1";

  const defaultState = {
    landlord: {
      fullName: "",
      address: "",
      email: "",
      phone: "",
      city: "",
      signatureName: ""
    },
    tenants: []
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const parsed = JSON.parse(raw);
      return {
        landlord: { ...defaultState.landlord, ...(parsed.landlord || {}) },
        tenants: Array.isArray(parsed.tenants) ? parsed.tenants : []
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // -------------------------
  // Helpers
  // -------------------------
  const $ = (sel) => document.querySelector(sel);

  function uid(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function euro(n){
    const val = Number(n || 0);
    return val.toLocaleString("fr-FR", { style:"currency", currency:"EUR" });
  }

  function monthLabel(year, monthIndex){
    const d = new Date(year, monthIndex, 1);
    return d.toLocaleDateString("fr-FR", { month:"long", year:"numeric" });
  }

  function toast(msg){
    $("#toast").textContent = msg;
    setTimeout(() => { if($("#toast").textContent === msg) $("#toast").textContent = ""; }, 3500);
  }

  function setTab(tab){
    document.querySelectorAll(".pill[role='tab']").forEach(p => {
      const on = p.dataset.tab === tab;
      p.setAttribute("aria-selected", on ? "true" : "false");
    });
    render(tab);
  }

  // -------------------------
  // Renderers
  // -------------------------
  function render(tab){
    if(tab === "bailleur") renderLandlord();
    if(tab === "locataires") renderTenants();
    if(tab === "quittances") renderReceipts();
  }

  function renderLandlord(){
    $("#leftTitle").textContent = "Informations bailleur";
    $("#leftHint").textContent = "Ces infos apparaissent sur les quittances";
    $("#leftBody").innerHTML = `
      <div class="row">
        <div>
          <label>Nom / Raison sociale</label>
          <input id="l_fullName" placeholder="Ex : Jean Dupont" value="${escapeHtml(state.landlord.fullName)}"/>
        </div>
        <div>
          <label>Ville (pour ‚ÄúFait √† ‚Ä¶‚Äù)</label>
          <input id="l_city" placeholder="Ex : Paris" value="${escapeHtml(state.landlord.city)}"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Email</label>
          <input id="l_email" placeholder="ex: jean@exemple.fr" value="${escapeHtml(state.landlord.email)}"/>
        </div>
        <div>
          <label>T√©l√©phone</label>
          <input id="l_phone" placeholder="ex: 06..." value="${escapeHtml(state.landlord.phone)}"/>
        </div>
      </div>

      <div>
        <label>Adresse bailleur</label>
        <textarea id="l_address" placeholder="Adresse compl√®te">${escapeHtml(state.landlord.address)}</textarea>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Nom affich√© pour la signature (optionnel)</label>
          <input id="l_signatureName" placeholder="Par d√©faut : Nom / Raison sociale" value="${escapeHtml(state.landlord.signatureName)}"/>
        </div>
        <div></div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnSaveLandlord">Enregistrer</button>
      </div>
      <div class="note">üí° Conseil : renseigne aussi une adresse et un email pour que tes quittances soient plus compl√®tes.</div>
    `;

    $("#btnSaveLandlord").addEventListener("click", () => {
      state.landlord.fullName = $("#l_fullName").value.trim();
      state.landlord.city = $("#l_city").value.trim();
      state.landlord.email = $("#l_email").value.trim();
      state.landlord.phone = $("#l_phone").value.trim();
      state.landlord.address = $("#l_address").value.trim();
      state.landlord.signatureName = $("#l_signatureName").value.trim();
      saveState();
      toast("Infos bailleur enregistr√©es ‚úÖ");
    });
  }

  function renderTenants(){
    $("#leftTitle").textContent = "Locataires";
    $("#leftHint").textContent = `${state.tenants.length} enregistr√©(s)`;

    const listHtml = state.tenants.length
      ? `<div class="list">
          ${state.tenants.map(t => `
            <div class="item">
              <div class="meta">
                <div class="name">${escapeHtml(t.fullName || "Sans nom")}</div>
                <div class="sub">
                  Logement : ${escapeHtml(t.propertyAddress || "‚Äî")}<br/>
                  Loyer HC : ${euro(t.rentHc)} ‚Ä¢ Charges : ${euro(t.charges)}
                </div>
              </div>
              <div class="right">
                <button class="btn" data-edit="${t.id}">Modifier</button>
                <button class="btn danger" data-del="${t.id}">Supprimer</button>
              </div>
            </div>
          `).join("")}
        </div>`
      : `<div class="note">Aucun locataire. Ajoute le premier ci-dessous.</div>`;

    $("#leftBody").innerHTML = `
      ${listHtml}

      <div style="height:14px"></div>

      <div class="card" style="border-radius:18px">
        <div class="head" style="border-bottom:1px solid var(--border)">
          <h2 id="tenantFormTitle">Ajouter un locataire</h2>
          <div class="hint" id="tenantFormHint">loyer HC + charges</div>
        </div>
        <div class="body" id="tenantForm"></div>
      </div>
    `;

    renderTenantForm(null);

    // bind list actions
    document.querySelectorAll("[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const t = state.tenants.find(x => x.id === id);
        renderTenantForm(t || null);
        $("#tenantFormTitle").textContent = "Modifier le locataire";
        $("#tenantFormHint").textContent = id;
      });
    });
    document.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const t = state.tenants.find(x => x.id === id);
        if(!confirm(`Supprimer ${t?.fullName || "ce locataire"} ?`)) return;
        state.tenants = state.tenants.filter(x => x.id !== id);
        saveState();
        toast("Locataire supprim√© üóëÔ∏è");
        renderTenants();
      });
    });
  }

  function renderTenantForm(tenant){
    const isEdit = !!tenant;
    const t = tenant || {
      id: uid(),
      fullName: "",
      tenantAddress: "",
      propertyAddress: "",
      rentHc: 0,
      charges: 0,
      paymentMethod: "Virement"
    };

    $("#tenantForm").innerHTML = `
      <div class="row">
        <div>
          <label>Nom du locataire</label>
          <input id="t_fullName" placeholder="Ex : Marie Martin" value="${escapeHtml(t.fullName)}"/>
        </div>
        <div>
          <label>Moyen de paiement (affich√© sur la quittance)</label>
          <select id="t_paymentMethod">
            ${["Virement","Ch√®que","Esp√®ces","Pr√©l√®vement","Autre"].map(v => `
              <option ${t.paymentMethod===v ? "selected":""} value="${v}">${v}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Adresse du locataire (optionnel)</label>
          <textarea id="t_tenantAddress" placeholder="Adresse compl√®te">${escapeHtml(t.tenantAddress || "")}</textarea>
        </div>
        <div>
          <label>Adresse du logement lou√©</label>
          <textarea id="t_propertyAddress" placeholder="Adresse compl√®te du logement">${escapeHtml(t.propertyAddress || "")}</textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Loyer mensuel hors charges (‚Ç¨)</label>
          <input id="t_rentHc" type="number" step="0.01" min="0" value="${Number(t.rentHc||0)}"/>
        </div>
        <div>
          <label>Charges mensuelles (‚Ç¨)</label>
          <input id="t_charges" type="number" step="0.01" min="0" value="${Number(t.charges||0)}"/>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnSaveTenant">${isEdit ? "Enregistrer les modifications" : "Ajouter le locataire"}</button>
        ${isEdit ? `<button class="btn" id="btnCancelEdit">Annuler</button>` : ""}
      </div>
    `;

    $("#btnSaveTenant").addEventListener("click", () => {
      t.fullName = $("#t_fullName").value.trim();
      t.paymentMethod = $("#t_paymentMethod").value;
      t.tenantAddress = $("#t_tenantAddress").value.trim();
      t.propertyAddress = $("#t_propertyAddress").value.trim();
      t.rentHc = Number($("#t_rentHc").value || 0);
      t.charges = Number($("#t_charges").value || 0);

      if(!t.fullName){
        alert("Le nom du locataire est obligatoire.");
        return;
      }
      if(!t.propertyAddress){
        alert("L‚Äôadresse du logement est obligatoire.");
        return;
      }

      if(isEdit){
        const idx = state.tenants.findIndex(x => x.id === t.id);
        if(idx >= 0) state.tenants[idx] = t;
      }else{
        state.tenants.unshift(t);
      }

      saveState();
      toast(isEdit ? "Locataire mis √† jour ‚úÖ" : "Locataire ajout√© ‚úÖ");
      renderTenants();
    });

    if(isEdit){
      $("#btnCancelEdit").addEventListener("click", () => renderTenants());
    }
  }

  function renderReceipts(){
    $("#leftTitle").textContent = "G√©n√©rer une quittance PDF";
    $("#leftHint").textContent = "A4 ‚Ä¢ design √©pur√© ‚Ä¢ export imm√©diat";

    const options = state.tenants.map(t => `<option value="${t.id}">${escapeHtml(t.fullName)}</option>`).join("");
    const today = new Date();
    const y = today.getFullYear();
    const m = today.getMonth();

    $("#leftBody").innerHTML = `
      <div class="row">
        <div>
          <label>Locataire</label>
          <select id="r_tenantId">
            ${state.tenants.length ? options : `<option value="">Aucun locataire</option>`}
          </select>
        </div>
        <div>
          <label>P√©riode (mois / ann√©e)</label>
          <div class="row" style="margin:0; grid-template-columns:1fr 1fr; gap:10px">
            <select id="r_month">
              ${Array.from({length:12}).map((_,i) => {
                const d = new Date(2026, i, 1);
                const label = d.toLocaleDateString("fr-FR", { month:"long" });
                return `<option ${i===m ? "selected":""} value="${i}">${label}</option>`;
              }).join("")}
            </select>
            <input id="r_year" type="number" min="2000" max="2100" value="${y}" />
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Date d‚Äô√©dition (affich√©e sur la quittance)</label>
          <input id="r_date" type="date" value="${toISODate(today)}" />
        </div>
        <div>
          <label>R√©f√©rence (optionnel)</label>
          <input id="r_ref" placeholder="Ex : Q-${y}-${String(m+1).padStart(2,"0")}-001" />
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnGenerate" ${state.tenants.length ? "" : "disabled"}>G√©n√©rer le PDF</button>
      </div>

      <div class="note">
        ‚úÖ Le PDF se base sur : infos bailleur + locataire + loyer HC + charges.<br/>
        ‚ö†Ô∏è Pense √† g√©n√©rer une quittance uniquement si le loyer a √©t√© pay√© (c‚Äôest le principe d‚Äôune quittance).
      </div>
    `;

    $("#btnGenerate")?.addEventListener("click", async () => {
      const tenantId = $("#r_tenantId").value;
      const tenant = state.tenants.find(t => t.id === tenantId);
      if(!tenant) return;

      const monthIndex = Number($("#r_month").value);
      const year = Number($("#r_year").value);
      const dateStr = $("#r_date").value;
      const ref = ($("#r_ref").value || "").trim() || `Q-${year}-${String(monthIndex+1).padStart(2,"0")}-${tenant.fullName.replaceAll(" ","_")}`;

      const periodLabel = capitalize(monthLabel(year, monthIndex));
      const rent = Number(tenant.rentHc || 0);
      const charges = Number(tenant.charges || 0);
      const total = rent + charges;

      // Fill template
      $("#pdfPeriod").textContent = `P√©riode : ${periodLabel}`;
      $("#pdfRef").textContent = ref;

      const landlord = state.landlord;
      const landlordLines = [
        landlord.fullName || "‚Äî",
        landlord.address || "",
        landlord.email ? `Email : ${landlord.email}` : "",
        landlord.phone ? `T√©l : ${landlord.phone}` : ""
      ].filter(Boolean).join("\n");

      const tenantLines = [
        tenant.fullName || "‚Äî",
        tenant.tenantAddress || "",
      ].filter(Boolean).join("\n");

      $("#pdfLandlordLines").textContent = landlordLines || "‚Äî";
      $("#pdfTenantLines").textContent = tenantLines || "‚Äî";
      $("#pdfProperty").textContent = tenant.propertyAddress || "‚Äî";

      $("#pdfRent").textContent = euro(rent);
      $("#pdfCharges").textContent = euro(charges);
      $("#pdfTotal").textContent = euro(total);
      $("#pdfTotalLine").textContent = `Total : ${euro(total)}`;

      const city = landlord.city || "‚Äî";
      const editedDate = dateStr ? formatFRDate(dateStr) : "‚Äî";
      $("#pdfFooterLeft").innerHTML = `
        Fait √† ${escapeHtml(city)}, le ${escapeHtml(editedDate)}<br/>
        Paiement : ${escapeHtml(tenant.paymentMethod || "‚Äî")}<br/>
        <span style="color:#64748b">Document g√©n√©r√© automatiquement.</span>
      `;

      $("#pdfSignName").textContent = landlord.signatureName || landlord.fullName || "‚Äî";

      // Generate PDF
      const node = $("#pdfTemplate").firstElementChild; // pdf-root
      const filename = `Quittance_${tenant.fullName}_${periodLabel.replace(" ","_")}.pdf`.replaceAll("/", "-");

      const opt = {
        margin:       [6, 6, 6, 6], // mm-ish via html2pdf
        filename,
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" }
      };

      try{
        await html2pdf().set(opt).from(node).save();
        toast("PDF g√©n√©r√© ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Impossible de g√©n√©rer le PDF. Regarde la console pour plus de d√©tails.");
      }
    });
  }

  // -------------------------
  // Export / Import / Reset
  // -------------------------
  $("#btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "quittances_data.json";
    a.click();
    URL.revokeObjectURL(url);
    toast("Export termin√© üì¶");
  });

  $("#btnImport").addEventListener("click", () => $("#fileImport").click());

  $("#fileImport").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      state = {
        landlord: { ...defaultState.landlord, ...(data.landlord || {}) },
        tenants: Array.isArray(data.tenants) ? data.tenants : []
      };
      saveState();
      toast("Import r√©ussi ‚úÖ");
      // rerender current tab
      const current = document.querySelector(".pill[aria-selected='true']")?.dataset.tab || "bailleur";
      render(current);
    }catch(err){
      alert("Fichier invalide.");
    }finally{
      e.target.value = "";
    }
  });

  $("#btnReset").addEventListener("click", () => {
    if(!confirm("Tout effacer ? (bailleur + locataires)")) return;
    state = structuredClone(defaultState);
    saveState();
    toast("Donn√©es effac√©es ‚úÖ");
    setTab("bailleur");
  });

  // -------------------------
  // Tabs interactions
  // -------------------------
  document.querySelectorAll(".pill[role='tab']").forEach(p => {
    p.addEventListener("click", () => setTab(p.dataset.tab));
    p.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " ") setTab(p.dataset.tab);
    });
  });

  // Initial render
  render("bailleur");

  // -------------------------
  // Small utilities
  // -------------------------
  function toISODate(d){
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function formatFRDate(iso){
    // iso: YYYY-MM-DD
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, (m||1)-1, d||1);
    return dt.toLocaleDateString("fr-FR", { day:"2-digit", month:"long", year:"numeric" });
  }

  function capitalize(s){
    return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
</body>
</html>
